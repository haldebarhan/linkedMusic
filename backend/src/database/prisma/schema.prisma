// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum Role {
    USER
    ADMIN
    PROVIDER
}

enum ContactRequestStatus {
    PENDING
    ACCEPTED
    REJECTED
    CANCELED
}

enum HighlightLevel {
    STANDARD
    PRO
    PREMIUM
    VIP
}

enum Status {
    ACTIVATED
    DESACTIVATED
    SUSPENDED
    REMOVED
    CLOSED
    VERIFIED
    UNVERIFIED
}

enum FieldInputType {
    TEXT
    TEXTAREA
    NUMBER
    SELECT
    RADIO
    CHECKBOX
    MULTISELECT
    TOGGLE
    RANGE
    DATE
    FILE
}

enum AuthProvider {
    CREDENTIALS
    GOOGLE
}

enum SubscriptionStatus {
    ACTIVE
    CANCELED
    EXPIRED
    INCOMPLETE
    PAST_DUE
}

enum PlanStatus {
    ACTIVE
    REMOVED
    PENDING_REMOVAL
}

enum PlanPeriod {
    FREE
    MONTHLY
    BIMONTHLY
    QUARTERLY
    SEMIANNUAL
    ANNUAL
    CUSTOM
}

enum PaymentStatus {
    PENDING
    SUCCEEDED
    FAILED
    REFUNDED
}

enum PaymentProvider {
    CINETPAY
}

enum Currency {
    XOF
    EUR
    USD
}

enum PaymentPurpose {
    SUBSCRIPTION
    MATCHING_UNLOCK
    OTHER
}

enum AnnouncementStatus {
    DRAFT
    PENDING_APPROVAL
    PUBLISHED
    ARCHIVED
    REJECTED
}

enum ConfigType {
    BOOLEAN
    NUMBER
    STRING
    JSON
}

model User {
    id                    Int                @id @default(autoincrement())
    uid                   String             @unique
    email                 String             @unique
    phone                 String?            @unique
    displayName           String?            @map("display_name")
    firstName             String?            @map("first_name")
    lastName              String?            @map("last_name")
    role                  Role               @default(USER)
    status                Status             @default(ACTIVATED)
    profileImage          String             @map("profile_image")
    comments              String?
    location              String?
    country               String?
    city                  String?
    zipCode               String?            @map("zip_code")
    createdAt             DateTime           @default(now()) @map("created_at")
    updatedAt             DateTime           @updatedAt @map("updated_at")
    files                 File[]
    Favorites             Favorite[]
    messages              Message[]
    sentConversations     Conversation[]     @relation("ConversationSender")
    receivedConversations Conversation[]     @relation("ConversationReceiver")
    announcements         Announcement[]
    Payment               Payment[]
    MatchingAccess        MatchingAccess[]
    subscriptions         UserSubscription[]
    FreeClaim             FreeClaim?
    contactRequests       ContactRequest[]   @relation("ContactRequests")

    @@map("users")
}

model ContactRequest {
    id             Int                  @id @default(autoincrement())
    announcementId Int                  @map("announcement_id")
    requesterId    Int                  @map("requester_id")
    message        String?
    status         ContactRequestStatus @default(PENDING)
    createdAt      DateTime             @default(now()) @map("created_at")
    updatedAt      DateTime             @updatedAt @map("updated_at")
    respondedAt    DateTime?            @map("responded_at")
    announcement   Announcement         @relation(fields: [announcementId], references: [id], onDelete: Cascade)
    requester      User                 @relation("ContactRequests", fields: [requesterId], references: [id], onDelete: Cascade)
    conversation   Conversation?        @relation("ContactRequestConversation")
    conversationId Int?

    @@unique([announcementId, requesterId])
    @@index([announcementId, status])
    @@index([requesterId])
    @@map("contact_requests")
}

model ExternalAccount {
    id             Int          @id @default(autoincrement())
    userId         Int
    provider       AuthProvider
    providerUserId String

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([provider, providerUserId])
    @@index([userId])
    @@map("external_accounts")
}

model File {
    id         Int      @id @default(autoincrement()) @map("id")
    name       String   @map("name")
    fileUrl    String   @map("file_url")
    mimeType   String?  @map("mime_type") // image/jpeg, audio/mp3, video/mp4
    fileSize   Int?     @map("file_size")
    userId     Int      @map("user_id")
    uploadedAt DateTime @default(now()) @map("uploaded_at")
    User       User     @relation(fields: [userId], references: [id])

    @@index([userId])
    @@map("files")
}

model Category {
    id             Int             @id @default(autoincrement()) @map("id")
    name           String          @unique
    slug           String          @unique
    icon           String?
    order          Int             @default(0)
    active         Boolean         @default(true)
    createdAt      DateTime        @default(now())
    updatedAt      DateTime        @updatedAt
    announcements  Announcement[]
    categoryFields CategoryField[]

    @@map("categories")
}

model Field {
    id            Int            @id @default(autoincrement()) @map("id")
    key           String         @unique
    label         String
    inputType     FieldInputType
    placeholder   String?
    helpText      String?
    unit          String?
    required      Boolean        @default(false)
    minLength     Int?
    maxLength     Int?
    minValue      Float?
    maxValue      Float?
    pattern       String?
    dependsOn     String? // Clé du champ parent (ex: "experience_studio")
    showWhen      String?
    searchable    Boolean        @default(false) // Utilisable dans la recherche
    filterable    Boolean        @default(false) // Utilisable dans les filtres
    sortable      Boolean        @default(false)
    externalTable String?        @map("external_table")
    createdAt     DateTime       @default(now()) @map("created_at")
    updatedAt     DateTime       @updatedAt @map("updated_at")

    options        FieldOption[]
    annValues      AnnFieldValue[]
    categoryFields CategoryField[]

    @@index([key])
    @@map("fields")
}

model FieldOption {
    id                   Int                   @id @default(autoincrement()) @map("id")
    fieldId              Int                   @map("field_id")
    label                String
    value                String
    order                Int                   @default(0)
    active               Boolean               @default(true)
    metadata             Json?
    createdAt            DateTime              @default(now()) @map("created_at")
    updatedAt            DateTime              @updatedAt @map("updated_at")
    field                Field                 @relation(fields: [fieldId], references: [id], onDelete: Cascade)
    annFieldValueOptions AnnFieldValueOption[]

    @@unique([fieldId, value])
    @@index([fieldId])
    @@map("field_options")
}

model Announcement {
    id              Int                @id @default(autoincrement())
    title           String
    description     String
    ownerId         Int
    categoryId      Int
    images          String[]
    videos          String[]
    audios          String[]
    price           Int?
    priceUnit       String?            @map("price_unit")
    negotiable      Boolean            @default(false)
    location        String?
    country         String?
    countryCode     String?
    city            String?
    status          AnnouncementStatus @default(PENDING_APPROVAL)
    isPublished     Boolean            @default(false)
    isHighlighted   Boolean            @default(false)
    highlightLevel  HighlightLevel     @default(STANDARD)
    views           Int                @default(0)
    createdAt       DateTime           @default(now()) @map("created_at")
    updatedAt       DateTime           @updatedAt @map("updated_at")
    publishedAt     DateTime?          @map("published_at")
    user            User               @relation(fields: [ownerId], references: [id])
    category        Category           @relation(fields: [categoryId], references: [id])
    fieldValues     AnnFieldValue[]
    Favorites       Favorite[]
    conversations   Conversation[]
    matchingAccess  MatchingAccess[]
    contactRequests ContactRequest[]

    @@index([categoryId])
    @@index([ownerId])
    @@index([createdAt])
    @@index([status, isPublished])
    @@map("announcements")
}

model MusicStyle {
    id       Int     @id @default(autoincrement())
    name     String  @unique // "House", "Techno", "Afrobeat"
    slug     String  @unique
    category String? // "Électronique", "Africain", "Urban"
    active   Boolean @default(true)
    order    Int     @default(0)

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("music_styles")
}

model Instrument {
    id       Int     @id @default(autoincrement())
    name     String  @unique // "Piano", "Guitare", "Batterie"
    slug     String  @unique
    category String? // "Cordes", "Vents", "Percussions"
    active   Boolean @default(true)
    order    Int     @default(0)

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("instruments")
}

model Language {
    id     Int     @id @default(autoincrement())
    name   String  @unique // "Français", "Anglais"
    code   String  @unique // "fr", "en", "es"
    active Boolean @default(true)
    order  Int     @default(0)

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("languages")
}

model Software {
    id     Int     @id @default(autoincrement())
    name   String  @unique // "FL Studio", "Ableton Live"
    slug   String  @unique
    type   String // "DAW", "PLUGIN", "VST"
    active Boolean @default(true)
    order  Int     @default(0)

    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")

    @@map("software")
}

model CategoryField {
    categoryId      Int      @map("category_id")
    fieldId         Int      @map("field_id")
    required        Boolean  @default(false)
    visibleInFilter Boolean  @default(true)
    visibleInForm   Boolean  @default(true)
    visibleInList   Boolean  @default(true) @map("visible_in_list")
    order           Int      @default(0)
    defaultValue    Json?    @map("default_value")
    createdAt       DateTime @default(now()) @map("created_at")
    category        Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
    field           Field    @relation(fields: [fieldId], references: [id], onDelete: Cascade)

    @@id([categoryId, fieldId])
    @@index([categoryId])
    @@index([fieldId])
    @@map("category_fields")
}

model AnnFieldValue {
    id             BigInt                @id @default(autoincrement())
    announcementId Int
    fieldId        Int
    valueText      String?               @map("value_text") // Pour TEXT, TEXTAREA, SELECT, RADIO
    valueNumber    Float?                @map("value_number") // Pour NUMBER, RANGE
    valueBoolean   Boolean?              @map("value_boolean")
    valueDate      DateTime?             @map("value_date") // Pour DATE
    valueJson      Json?                 @map("value_json")
    createdAt      DateTime              @default(now())
    updatedAt      DateTime              @updatedAt
    announcement   Announcement          @relation(fields: [announcementId], references: [id], onDelete: Cascade)
    field          Field                 @relation(fields: [fieldId], references: [id], onDelete: Cascade)
    options        AnnFieldValueOption[]

    @@unique([announcementId, fieldId])
    @@index([fieldId])
    @@index([fieldId, valueBoolean])
    @@index([fieldId, valueNumber])
    @@map("ann_field_values")
}

model AnnFieldValueOption {
    id              BigInt        @id @default(autoincrement())
    annFieldValueId BigInt
    optionId        Int
    annFieldValue   AnnFieldValue @relation(fields: [annFieldValueId], references: [id], onDelete: Cascade)
    option          FieldOption   @relation(fields: [optionId], references: [id], onDelete: Cascade)

    @@unique([annFieldValueId, optionId])
    @@index([optionId])
    @@map("ann_field_value_options")
}

model Favorite {
    id             Int          @id @default(autoincrement()) @map("id")
    userId         Int
    announcementId Int
    createdAt      DateTime     @default(now())
    user           User         @relation(fields: [userId], references: [id])
    announcement   Announcement @relation(fields: [announcementId], references: [id])

    @@map("favorites")
}

model Conversation {
    id               Int             @id @default(autoincrement()) @map("id")
    senderId         Int
    receiverId       Int
    sender           User            @relation("ConversationSender", fields: [senderId], references: [id])
    receiver         User            @relation("ConversationReceiver", fields: [receiverId], references: [id])
    announcementId   Int?
    contactRequestId Int?            @unique @map("contact_request_id")
    announcement     Announcement?   @relation(fields: [announcementId], references: [id])
    createdAt        DateTime        @default(now())
    messages         Message[]
    contactRequest   ContactRequest? @relation("ContactRequestConversation", fields: [contactRequestId], references: [id])

    @@unique([senderId, receiverId, announcementId])
    @@map("conversations")
}

model Message {
    id             Int          @id @default(autoincrement()) @map("id")
    conversationId Int
    senderId       Int
    content        String
    readAt         DateTime?
    createdAt      DateTime     @default(now())
    conversation   Conversation @relation(fields: [conversationId], references: [id])
    sender         User         @relation(fields: [senderId], references: [id])

    @@index([conversationId])
    @@index([senderId])
    @@index([readAt])
    @@map("messages")
}

model Styles {
    id        Int      @id @default(autoincrement()) @map("id")
    name      String   @unique
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("styles")
}

model AppConfig {
    id        Int      @id @default(autoincrement()) @map("id")
    key       String   @unique
    value     String
    type      String
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("app_configs")
}

model Payment {
    id             Int               @id @default(autoincrement())
    userId         Int               @map("user_id")
    reference      String            @unique
    amount         Int // Montant en centimes
    currency       Currency          @default(XOF)
    status         PaymentStatus     @default(PENDING)
    provider       PaymentProvider
    purpose        PaymentPurpose    @default(SUBSCRIPTION)
    planId         Int?              @map("plan_id")
    // Métadonnées du paiement
    providerData   Json?             @map("provider_data") // Données du provider
    createdAt      DateTime          @default(now()) @map("created_at")
    updatedAt      DateTime          @updatedAt @map("updated_at")
    paidAt         DateTime?         @map("paid_at")
    user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
    plan           SubscriptionPlan? @relation(fields: [planId], references: [id])
    matchingAccess MatchingAccess[]

    @@index([userId, status, purpose])
    @@index([purpose, status])
    @@index([createdAt])
    @@map("payments")
}

model MatchingAccess {
    id             Int          @id @default(autoincrement())
    userId         Int
    announcementId Int
    grantedAt      DateTime     @default(now())
    paymentId      Int?
    user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
    announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
    payment        Payment?     @relation(fields: [paymentId], references: [id])

    @@unique([userId, announcementId])
    @@index([announcementId])
    @@map("matching_access")
}

model Benefit {
    id          Int           @id @default(autoincrement())
    code        String        @unique // ex: "MATCHING_LIMIT_5", "FEATURE_X"
    label       String
    description String?
    plans       PlanBenefit[]
    createdAt   DateTime      @default(now())
    updatedAt   DateTime      @updatedAt
}

model PlanBenefit {
    planId    Int
    benefitId Int
    inherited Boolean          @default(false)
    plan      SubscriptionPlan @relation(fields: [planId], references: [id])
    benefit   Benefit          @relation(fields: [benefitId], references: [id])

    @@id([planId, benefitId])
}

model SubscriptionPlan {
    id            Int                @id @default(autoincrement())
    name          String
    slug          String             @unique
    period        PlanPeriod
    isFree        Boolean            @default(false)
    priceCents    Int                @default(0)
    currency      Currency           @default(XOF)
    durationDays  Int?
    status        PlanStatus         @default(ACTIVE)
    active        Boolean            @default(true)
    parentId      Int?
    parent        SubscriptionPlan?  @relation("PlanParent", fields: [parentId], references: [id])
    children      SubscriptionPlan[] @relation("PlanParent")
    benefits      PlanBenefit[]
    createdAt     DateTime           @default(now())
    updatedAt     DateTime           @updatedAt
    subscriptions UserSubscription[]
    payments      Payment[]
}

model UserSubscription {
    id        Int                @id @default(autoincrement())
    userId    Int
    planId    Int
    startAt   DateTime           @default(now())
    endAt     DateTime?
    status    SubscriptionStatus @default(ACTIVE)
    autoRenew Boolean            @default(true)
    user      User               @relation(fields: [userId], references: [id])
    plan      SubscriptionPlan   @relation(fields: [planId], references: [id])

    @@index([userId, status])
}

model FreeClaim {
    userId    Int      @unique
    claimedAt DateTime @default(now())
    user      User     @relation(fields: [userId], references: [id])
}
