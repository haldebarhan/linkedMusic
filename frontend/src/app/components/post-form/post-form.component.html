<div class="container py-4">
  <!-- Loading State -->
  <div *ngIf="loadingSchema" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Chargement...</span>
    </div>
    <p class="mt-3">Chargement du formulaire...</p>
  </div>

  <!-- Formulaire -->
  <form
    [formGroup]="form"
    (ngSubmit)="submit()"
    novalidate
    *ngIf="!loadingSchema && form"
  >
    <!-- En-tête Catégorie -->
    <div
      class="rub-head bg-rub px-3 py-2 rounded text-white mb-4 d-flex justify-content-between align-items-center"
    >
      <div>
        <span *ngIf="categorySchema?.icon" class="me-2">{{
          categorySchema?.icon
        }}</span>
        <strong>Rubrique :</strong> {{ categoryName }}
        <span *ngIf="announcementId" class="badge bg-warning ms-2"
          >Édition</span
        >
      </div>
      <a
        class="text-white text-decoration-underline cursor-pointer"
        (click)="backToCategories()"
      >
        Changer
      </a>
    </div>

    <div class="panel p-3 p-md-4 rounded">
      <!-- ============================================ -->
      <!-- CHAMPS DE BASE -->
      <!-- ============================================ -->

      <!-- Titre -->
      <div class="row align-items-center mb-3">
        <div class="col-md-3 text-md-end">
          <label class="form-label mb-0">
            Titre <span class="text-danger">*</span>
          </label>
        </div>
        <div class="col-md-6">
          <input
            class="form-control"
            [class.is-invalid]="
              form.get('title')?.invalid && form.get('title')?.touched
            "
            formControlName="title"
            placeholder="Titre de l'annonce"
          />
          <div
            class="invalid-feedback"
            *ngIf="form.get('title')?.invalid && form.get('title')?.touched"
          >
            <div *ngIf="form.get('title')?.errors?.['required']">
              Le titre est obligatoire
            </div>
            <div *ngIf="form.get('title')?.errors?.['minlength']">
              Le titre doit contenir au moins 5 caractères
            </div>
          </div>
        </div>
      </div>

      <!-- Description -->
      <div class="row align-items-top mb-3">
        <div class="col-md-3 text-md-end">
          <label class="form-label mb-0">
            Description <span class="text-danger">*</span>
          </label>
        </div>
        <div class="col-md-6">
          <textarea
            rows="6"
            class="form-control"
            [class.is-invalid]="
              form.get('description')?.invalid &&
              form.get('description')?.touched
            "
            formControlName="description"
            placeholder="Décrivez votre annonce en détail..."
          ></textarea>
          <div
            class="invalid-feedback"
            *ngIf="
              form.get('description')?.invalid &&
              form.get('description')?.touched
            "
          >
            <div *ngIf="form.get('description')?.errors?.['required']">
              La description est obligatoire
            </div>
            <div *ngIf="form.get('description')?.errors?.['minlength']">
              La description doit contenir au moins 20 caractères
            </div>
          </div>
        </div>
      </div>

      <!-- ============================================ -->
      <!-- CHAMPS DYNAMIQUES -->
      <!-- ============================================ -->

      <ng-container *ngFor="let categoryField of visibleFields">
        <ng-container [ngSwitch]="categoryField.field.inputType">
          <!-- TEXT -->
          <div class="row align-items-center mb-3" *ngSwitchCase="'TEXT'">
            <div class="col-md-3 text-md-end">
              <label class="form-label mb-0">
                {{ categoryField.field.label }}
                <span class="text-danger" *ngIf="categoryField.required"
                  >*</span
                >
              </label>
            </div>
            <div class="col-md-6">
              <input
                class="form-control"
                [class.is-invalid]="
                  form.get(categoryField.field.key)?.invalid &&
                  form.get(categoryField.field.key)?.touched
                "
                [placeholder]="categoryField.field.placeholder || ''"
                [formControlName]="categoryField.field.key"
              />
              <small class="text-muted" *ngIf="categoryField.field.helpText">
                {{ categoryField.field.helpText }}
              </small>
              <div
                class="invalid-feedback"
                *ngIf="
                  form.get(categoryField.field.key)?.invalid &&
                  form.get(categoryField.field.key)?.touched
                "
              >
                {{ getErrorMessage(categoryField) }}
              </div>
            </div>
          </div>

          <!-- NUMBER -->
          <div class="row align-items-center mb-3" *ngSwitchCase="'NUMBER'">
            <div class="col-md-3 text-md-end">
              <label class="form-label mb-0">
                {{ categoryField.field.label }}
                <span class="text-danger" *ngIf="categoryField.required"
                  >*</span
                >
              </label>
            </div>
            <div class="col-md-6">
              <div class="input-group">
                <input
                  type="number"
                  class="form-control"
                  [class.is-invalid]="
                    form.get(categoryField.field.key)?.invalid &&
                    form.get(categoryField.field.key)?.touched
                  "
                  [placeholder]="categoryField.field.placeholder || ''"
                  [formControlName]="categoryField.field.key"
                  [min]="categoryField.field.minValue ?? null"
                  [max]="categoryField.field.maxValue ?? null"
                />
                <span class="input-group-text" *ngIf="categoryField.field.unit">
                  {{ categoryField.field.unit }}
                </span>
              </div>
              <small class="text-muted" *ngIf="categoryField.field.helpText">
                {{ categoryField.field.helpText }}
              </small>
              <div
                class="invalid-feedback d-block"
                *ngIf="
                  form.get(categoryField.field.key)?.invalid &&
                  form.get(categoryField.field.key)?.touched
                "
              >
                {{ getErrorMessage(categoryField) }}
              </div>
            </div>
          </div>

          <!-- TEXTAREA -->
          <div class="row align-items-top mb-3" *ngSwitchCase="'TEXTAREA'">
            <div class="col-md-3 text-md-end">
              <label class="form-label mb-0">
                {{ categoryField.field.label }}
                <span class="text-danger" *ngIf="categoryField.required"
                  >*</span
                >
              </label>
            </div>
            <div class="col-md-9">
              <textarea
                rows="4"
                class="form-control"
                [class.is-invalid]="
                  form.get(categoryField.field.key)?.invalid &&
                  form.get(categoryField.field.key)?.touched
                "
                [placeholder]="categoryField.field.placeholder || ''"
                [formControlName]="categoryField.field.key"
              ></textarea>
              <small class="text-muted" *ngIf="categoryField.field.helpText">
                {{ categoryField.field.helpText }}
              </small>
              <div
                class="invalid-feedback"
                *ngIf="
                  form.get(categoryField.field.key)?.invalid &&
                  form.get(categoryField.field.key)?.touched
                "
              >
                {{ getErrorMessage(categoryField) }}
              </div>
            </div>
          </div>

          <!-- SELECT -->
          <div class="row align-items-center mb-3" *ngSwitchCase="'SELECT'">
            <div class="col-md-3 text-md-end">
              <label class="form-label mb-0">
                {{ categoryField.field.label }}
                <span class="text-danger" *ngIf="categoryField.required"
                  >*</span
                >
              </label>
            </div>
            <div class="col-md-6">
              <select
                class="form-select"
                [class.is-invalid]="
                  form.get(categoryField.field.key)?.invalid &&
                  form.get(categoryField.field.key)?.touched
                "
                [formControlName]="categoryField.field.key"
              >
                <option value="">— Sélectionner —</option>
                <option
                  *ngFor="let option of categoryField.field.options"
                  [value]="option.value"
                  [disabled]="!option.active"
                >
                  {{ option.label }}
                </option>
              </select>
              <small class="text-muted" *ngIf="categoryField.field.helpText">
                {{ categoryField.field.helpText }}
              </small>
              <div
                class="invalid-feedback"
                *ngIf="
                  form.get(categoryField.field.key)?.invalid &&
                  form.get(categoryField.field.key)?.touched
                "
              >
                {{ getErrorMessage(categoryField) }}
              </div>
            </div>
          </div>

          <!-- RADIO -->
          <div class="row align-items-center mb-3" *ngSwitchCase="'RADIO'">
            <div class="col-md-3 text-md-end">
              <label class="form-label mb-0">
                {{ categoryField.field.label }}
                <span class="text-danger" *ngIf="categoryField.required"
                  >*</span
                >
              </label>
            </div>
            <div class="col-md-9">
              <div class="d-flex flex-wrap gap-3">
                <div
                  class="form-check"
                  *ngFor="let option of categoryField.field.options"
                >
                  <input
                    class="form-check-input"
                    type="radio"
                    [value]="option.value"
                    [formControlName]="categoryField.field.key"
                    [id]="categoryField.field.key + '_' + option.value"
                    [disabled]="!option.active"
                  />
                  <label
                    class="form-check-label"
                    [for]="categoryField.field.key + '_' + option.value"
                  >
                    {{ option.label }}
                  </label>
                </div>
              </div>
              <small
                class="text-muted d-block mt-1"
                *ngIf="categoryField.field.helpText"
              >
                {{ categoryField.field.helpText }}
              </small>
              <div
                class="text-danger small mt-1"
                *ngIf="
                  form.get(categoryField.field.key)?.invalid &&
                  form.get(categoryField.field.key)?.touched
                "
              >
                {{ getErrorMessage(categoryField) }}
              </div>
            </div>
          </div>

          <!-- CHECKBOX -->
          <div class="row align-items-start mb-3" *ngSwitchCase="'CHECKBOX'">
            <div class="col-md-3 text-md-end">
              <label class="form-label mb-0">
                {{ categoryField.field.label }}
                <span class="text-danger" *ngIf="categoryField.required"
                  >*</span
                >
              </label>
            </div>
            <div class="col-md-9">
              <div class="d-flex flex-wrap gap-3">
                <div
                  class="form-check"
                  *ngFor="let option of categoryField.field.options"
                >
                  <input
                    class="form-check-input"
                    type="checkbox"
                    [checked]="isInArray(categoryField.field.key, option.value)"
                    (change)="
                      onMultiToggle(
                        categoryField.field.key,
                        option.value,
                        $event
                      )
                    "
                    [id]="categoryField.field.key + '_' + option.value"
                    [disabled]="!option.active"
                  />
                  <label
                    class="form-check-label"
                    [for]="categoryField.field.key + '_' + option.value"
                  >
                    {{ option.label }}
                  </label>
                </div>
              </div>
              <small
                class="text-muted d-block mt-1"
                *ngIf="categoryField.field.helpText"
              >
                {{ categoryField.field.helpText }}
              </small>
            </div>
          </div>

          <!-- MULTISELECT -->
          <div class="row align-items-start mb-3" *ngSwitchCase="'MULTISELECT'">
            <div class="col-md-3 text-md-end">
              <label class="form-label mb-0">
                {{ categoryField.field.label }}
                <span class="text-danger" *ngIf="categoryField.required"
                  >*</span
                >
              </label>
            </div>
            <div class="col-md-9">
              <div class="row">
                <div class="col-md-6">
                  <div
                    class="form-check"
                    *ngFor="let option of categoryField.field.options"
                  >
                    <input
                      class="form-check-input"
                      type="checkbox"
                      [checked]="
                        isInArray(categoryField.field.key, option.value)
                      "
                      (change)="
                        onMultiToggle(
                          categoryField.field.key,
                          option.value,
                          $event
                        )
                      "
                      [id]="categoryField.field.key + '_' + option.value"
                      [disabled]="!option.active"
                    />
                    <label
                      class="form-check-label"
                      [for]="categoryField.field.key + '_' + option.value"
                    >
                      {{ option.label }}
                    </label>
                  </div>
                </div>
              </div>
              <small
                class="text-muted d-block mt-2"
                *ngIf="categoryField.field.helpText"
              >
                {{ categoryField.field.helpText }}
              </small>
            </div>
          </div>

          <!-- TOGGLE -->
          <div class="row align-items-center mb-3" *ngSwitchCase="'TOGGLE'">
            <div class="col-md-3 text-md-end">
              <label class="form-label mb-0">
                {{ categoryField.field.label }}
              </label>
            </div>
            <div class="col-md-9">
              <div class="form-check form-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  role="switch"
                  [checked]="form.get(categoryField.field.key)?.value"
                  (change)="onToggleChange(categoryField.field.key, $event)"
                  [id]="categoryField.field.key"
                />
                <label class="form-check-label" [for]="categoryField.field.key">
                  {{ form.get(categoryField.field.key)?.value ? "Oui" : "Non" }}
                </label>
              </div>
              <small
                class="text-muted d-block mt-1"
                *ngIf="categoryField.field.helpText"
              >
                {{ categoryField.field.helpText }}
              </small>
            </div>
          </div>

          <!-- RANGE -->
          <div class="row align-items-center mb-3" *ngSwitchCase="'RANGE'">
            <div class="col-md-3 text-md-end">
              <label class="form-label mb-0">{{
                categoryField.field.label
              }}</label>
            </div>
            <div class="col-md-9">
              <div class="row g-2">
                <div class="col-6">
                  <input
                    type="number"
                    class="form-control"
                    [placeholder]="categoryField.field.placeholder || 'Min'"
                    [formControlName]="categoryField.field.key + '_min'"
                  />
                </div>
                <div class="col-6">
                  <input
                    type="number"
                    class="form-control"
                    [placeholder]="categoryField.field.placeholder || 'Max'"
                    [formControlName]="categoryField.field.key + '_max'"
                  />
                </div>
              </div>
              <small
                class="text-muted d-block mt-1"
                *ngIf="categoryField.field.helpText"
              >
                {{ categoryField.field.helpText }}
              </small>
            </div>
          </div>
        </ng-container>
      </ng-container>

      <!-- ============================================ -->
      <!-- LOCALISATION -->
      <!-- ============================================ -->

      <div class="row align-items-center mb-3">
        <div class="col-md-3 text-md-end">
          <label class="form-label mb-0">Localisation</label>
        </div>
        <div class="col-md-3">
          <select class="form-select" formControlName="country">
            <option value="">— Pays —</option>
            <option *ngFor="let c of countries" [value]="c.name">
              {{ c.name }}
            </option>
          </select>
        </div>
        <div class="col-md-3">
          <input
            class="form-control"
            formControlName="city"
            placeholder="Ville"
          />
        </div>
      </div>

      <!-- Prix (optionnel) -->
      <div class="row align-items-center mb-3">
        <div class="col-md-3 text-md-end">
          <label class="form-label mb-0">Prix</label>
        </div>
        <div class="col-md-3">
          <div class="input-group">
            <input
              type="number"
              class="form-control"
              formControlName="price"
              placeholder="0"
            />
            <span class="input-group-text">FCFA</span>
          </div>
          <small class="text-muted">Laisser vide si non applicable</small>
        </div>
      </div>

      <!-- ============================================ -->
      <!-- FICHIERS -->
      <!-- ============================================ -->

      <div class="row align-items-top mb-4">
        <div class="col-md-3 text-md-end">
          <label class="form-label mb-0">Fichiers</label>
        </div>
        <div class="col-md-6">
          <input
            #fileInput
            type="file"
            class="form-control"
            accept="audio/*, video/*, image/*"
            (change)="onfileChange($event)"
            multiple
          />
          <small class="text-muted d-block mt-1">
            Images, audio ou vidéo. Max 50MB au total, 20MB par fichier. 5
            fichiers max
          </small>
          <div class="invalid-feedback d-block" *ngIf="fileSizeError">
            {{ fileSizeError }}
          </div>
        </div>
      </div>

      <!-- Preview des fichiers -->
      <div class="row mt-3" *ngIf="previewFiles && previewFiles.length > 0">
        <div class="col-md-9 offset-md-3">
          <app-media-gallery
            [files]="previewFiles"
            [deletable]="true"
            (remove)="onRemovePreview($event)"
          ></app-media-gallery>
        </div>
      </div>

      <!-- ============================================ -->
      <!-- BOUTONS D'ACTION -->
      <!-- ============================================ -->

      <div class="text-center mt-4 pt-3 border-top">
        <button
          type="button"
          class="btn btn-outline-secondary me-2"
          (click)="backToCategories()"
          [disabled]="submitting"
        >
          <i class="fas fa-arrow-left me-1"></i>
          Retour
        </button>
        <button
          class="btn btn-primary px-5"
          type="submit"
          [disabled]="form.invalid || submitting"
        >
          <span *ngIf="!submitting">
            <i class="fas fa-save me-1"></i>
            {{ announcementId ? "Mettre à jour" : "Publier l'annonce" }}
          </span>
          <span *ngIf="submitting">
            <span class="spinner-border spinner-border-sm me-1"></span>
            Enregistrement...
          </span>
        </button>
      </div>

      <!-- Aide -->
      <div class="alert alert-info mt-4" role="alert">
        <i class="fas fa-info-circle me-2"></i>
        <strong>Astuce :</strong> Les champs marqués d'une
        <span class="text-danger">*</span> sont obligatoires.
      </div>
      <div class="alert alert-danger mt-4" role="alert">
        <i class="fas fa-info-circle me-2"></i>
        <strong>Alerte :</strong> Les numéros et liens externes (Youtube,
        Facebook, ...) ne sont pas autorisés
      </div>
    </div>
  </form>

  <!-- Video Trimmer Modal -->
  <app-video-trimmer
    *ngIf="showVideoTrimmer && currentVideoToTrim"
    [isOpen]="showVideoTrimmer"
    [videoUrl]="currentVideoToTrim.url"
    [fileName]="currentVideoToTrim.file.name"
    [maxDuration]="MAX_VIDEO_DURATION"
    (trimmed)="onVideoTrimmed($event)"
    (closed)="onTrimmerClosed()"
  ></app-video-trimmer>

  <!-- Message d'information sur les vidéos -->
  <div class="alert alert-info mt-3" *ngIf="files.length > 0">
    <i class="fas fa-info-circle me-2"></i>
    <strong>Astuce :</strong>
    <span *ngIf="hasVideoFiles()">
      Les vidéos de plus de {{ MAX_VIDEO_DURATION }} secondes seront
      automatiquement proposées au découpage.
    </span>
    <span *ngIf="!hasVideoFiles()">
      Vous pouvez ajouter des images, vidéos (max {{ MAX_VIDEO_DURATION }}s) et
      audio.
    </span>
  </div>
</div>
