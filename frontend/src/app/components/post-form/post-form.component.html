<div class="container py-4" *ngIf="form">
  <!-- 1 seul form qui englobe tout -->
  <form [formGroup]="form" (ngSubmit)="submit()" novalidate>
    <!-- Rubrique / entête -->
    <div
      class="rub-head bg-rub px-3 py-2 rounded text-white mb-4 d-flex justify-content-between"
    >
      <div><strong>Rubrique :</strong> {{ categoryName }}</div>
      <a
        class="text-white text-decoration-underline"
        (click)="backToCategories()"
        >Changer</a
      >
    </div>

    <div class="panel p-3 p-md-4 rounded">
      <!-- TITRE (⚠️ DOIT ÊTRE DANS LE <form [formGroup]="form">) -->
      <div class="row align-items-center mb-3">
        <div class="col-md-3 text-md-end">
          <label class="form-label mb-0">Titre :</label>
        </div>
        <div class="col-md-6">
          <input
            class="form-control"
            formControlName="title"
            placeholder="Titre de l’annonce"
          />
        </div>
      </div>

      <!-- DESCRIPTION -->
      <div class="row align-items-top mb-3">
        <div class="col-md-3 text-md-end">
          <label class="form-label mb-0">Annonce :</label>
        </div>
        <div class="col-md-6">
          <textarea
            rows="6"
            class="form-control"
            formControlName="description"
            placeholder="Description de l’objet, état, caractéristiques…"
          ></textarea>
        </div>
      </div>

      <!-- Champs dynamiques -->
      <!-- astuce: si tu as des *ngSwitchCase, garde ce wrapper pour assurer le contexte formGroup -->
      <ng-container [formGroup]="form">
        <!-- Sous-rubrique -->
        <div class="row align-items-center mb-3">
          <div class="col-md-3 text-md-end">
            <label class="form-label mb-0">{{ label }}: </label>
          </div>
          <div class="col-md-6">
            <select class="form-select" formControlName="serviceType">
              <option value="">— Choisir —</option>
              <option *ngFor="let s of services" [value]="s.id">
                {{ s.name }}
              </option>
            </select>
          </div>
        </div>
        <ng-container
          *ngIf="
            categorySlug === 'musiciens' && services && services.length > 0
          "
        >
          <div class="row align-items-center mb-3">
            <div class="col-md-3 text-md-end">
              <label class="form-label mb-0">Je cherche: </label>
            </div>
            <div class="col-md-6">
              <select class="form-select" formControlName="searchServiceType">
                <option value="">— Choisir —</option>
                <option *ngFor="let s of services" [value]="s.id">
                  {{ s.name }}
                </option>
              </select>
            </div>
          </div>
        </ng-container>
        <ng-container *ngFor="let f of dynFields" [ngSwitch]="f.type">
          <!-- TEXT -->
          <div class="row align-items-center mb-3" *ngSwitchCase="'TEXT'">
            <div class="col-md-3 text-md-end">
              <label class="form-label mb-0">{{ f.label }} :</label>
            </div>
            <div class="col-md-6">
              <input
                class="form-control"
                [placeholder]="f.placeholder || ''"
                [formControlName]="f.key"
              />
            </div>
          </div>

          <!-- NUMBER -->
          <div class="row align-items-center mb-3" *ngSwitchCase="'NUMBER'">
            <div class="col-md-3 text-md-end">
              <label class="form-label mb-0">{{ f.label }} :</label>
            </div>
            <div class="col-md-6">
              <div class="input-group">
                <input
                  type="number"
                  class="form-control"
                  [placeholder]="f.placeholder || ''"
                  [formControlName]="f.key"
                />
                <span class="input-group-text" *ngIf="f.unit">{{
                  f.unit
                }}</span>
              </div>
            </div>
          </div>

          <!-- TEXTAREA -->
          <div class="row align-items-center mb-3" *ngSwitchCase="'TEXTAREA'">
            <div class="col-md-3 text-md-end">
              <label class="form-label mb-0">{{ f.label }} :</label>
            </div>
            <div class="col-md-9">
              <textarea
                rows="4"
                class="form-control"
                [placeholder]="f.placeholder || ''"
                [formControlName]="f.key"
              ></textarea>
            </div>
          </div>

          <!-- SELECT -->
          <div class="row align-items-center mb-3" *ngSwitchCase="'SELECT'">
            <div class="col-md-3 text-md-end">
              <label class="form-label mb-0">{{ f.label }} :</label>
            </div>
            <div class="col-md-6">
              <select class="form-select" [formControlName]="f.key">
                <option value="">— Indifférent —</option>
                <option *ngFor="let o of f.options" [value]="o.value">
                  {{ o.label }}
                </option>
              </select>
            </div>
          </div>

          <!-- RADIO -->
          <div class="row align-items-center mb-3" *ngSwitchCase="'RADIO'">
            <div class="col-md-3 text-md-end">
              <label class="form-label mb-0">{{ f.label }} :</label>
            </div>
            <div class="col-md-9 d-flex flex-wrap gap-3">
              <div class="form-check" *ngFor="let o of f.options">
                <input
                  class="form-check-input"
                  type="radio"
                  [value]="o.value"
                  [formControlName]="f.key"
                />
                <label class="form-check-label">{{ o.label }}</label>
              </div>
            </div>
          </div>

          <!-- MULTISELECT / CHECKBOX -->
          <div class="row align-items-start mb-3" *ngSwitchCase="'MULTISELECT'">
            <div class="col-md-3 text-md-end">
              <label class="form-label mb-0">Je joue:</label>
            </div>
            <div class="col-9">
              <div class="row">
                <div class="col-md-6">
                  <div class="form-check" *ngFor="let o of f.options">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      [checked]="isInArray(f.key, o.value)"
                      (change)="onMultiToggle(f.key, o.value, $event)"
                    />
                    <label class="form-check-label">{{ o.label }}</label>
                  </div>
                </div>
                <div class="col-md-4"></div>
              </div>
            </div>
          </div>

          <div class="row align-items-center mb-3" *ngSwitchCase="'CHECKBOX'">
            <div class="col-md-3 text-md-end">
              <label class="form-label mb-0">{{ f.label }}:</label>
            </div>
            <div class="col-md-9 d-flex flex-wrap gap-3">
              <div class="form-check" *ngFor="let o of f.options">
                <input
                  class="form-check-input"
                  type="checkbox"
                  [checked]="isInArray(f.key, o.value)"
                  (change)="onMultiToggle(f.key, o.value, $event)"
                />
                <label class="form-check-label">{{ o.label }}</label>
              </div>
            </div>
          </div>

          <!-- TOGGLE -->
          <div class="row align-items-center mb-3" *ngSwitchCase="'TOGGLE'">
            <div class="col-md-3 text-md-end">
              <label class="form-label mb-0">{{ f.label }} :</label>
            </div>
            <div class="col-md-9">
              <div class="form-check form-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  [checked]="form.get(f.key)?.value"
                  (change)="onToggleChange(f.key, $event)"
                />
              </div>
            </div>
          </div>

          <!-- RANGE -->
          <div class="row align-items-center mb-3" *ngSwitchCase="'RANGE'">
            <div class="col-md-3 text-md-end">
              <label class="form-label mb-0">{{ f.label }} :</label>
            </div>
            <div class="col-md-9">
              <div class="row g-2">
                <div class="col-6">
                  <input
                    type="number"
                    class="form-control"
                    [placeholder]="f.placeholder || 'Min'"
                    [formControlName]="f.key + '_min'"
                  />
                </div>
                <div class="col-6">
                  <input
                    type="number"
                    class="form-control"
                    [placeholder]="f.placeholder || 'Max'"
                    [formControlName]="f.key + '_max'"
                  />
                </div>
              </div>
            </div>
          </div>
        </ng-container>
      </ng-container>

      <!---- Location-->
      <div class="row align-items-top mb-3">
        <div class="col-md-3 text-md-end">
          <label class="form-label mb-0">Pays :</label>
        </div>
        <div class="col-md-3">
          <select class="form-select" formControlName="country">
            <option value="" disabled>— Indifférent —</option>
            <option *ngFor="let c of countries" value="{{ c.name }}">
              {{ c.name }}
            </option>
          </select>
        </div>
        <div class="col-md-3">
          <input
            class="form-control"
            formControlName="city"
            placeholder="Ville"
          />
        </div>
      </div>
      <!---- Photo-->
      <div class="row align-items-top mb-3">
        <div class="col-md-3 text-md-end">
          <label class="form-label mb-0">Fichiers :</label>
        </div>
        <div class="col-md-6">
          <input
            #fileInput
            type="file"
            class="form-control"
            accept="audio/*, video/*, image/*"
            (change)="onfileChange($event)"
            multiple
          />
        </div>
        <div class="row mt-4">
          <div class="col-md-9 offset-md-3">
            <app-media-gallery
              [files]="previewFiles || []"
              [deletable]="true"
              (remove)="onRemovePreview($event)"
            ></app-media-gallery>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="text-center">
        <button
          class="btn btn-primary px-4"
          type="submit"
          [disabled]="form.invalid || submitting"
        >
          {{
            submitting
              ? "Enregistrement…"
              : announcementId
              ? "Modifier"
              : "Enregister"
          }}
        </button>
      </div>
    </div>
  </form>
</div>
